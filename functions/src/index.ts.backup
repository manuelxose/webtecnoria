/* eslint-disable linebreak-style */

// import writeExcel from "./sheets";
export * from "./ssr";

/* eslint-disable max-len */
/* eslint-disable no-undef */
/* eslint-disable linebreak-style */
/* eslint-disable key-spacing */
/* eslint-disable linebreak-style */
/* eslint-disable @typescript-eslint/no-empty-function */
/* eslint-disable linebreak-style */
/* eslint-disable no-multiple-empty-lines */
/* eslint-disable @typescript-eslint/no-var-requires */
/* eslint-disable linebreak-style */
/* eslint-disable @typescript-eslint/no-unused-vars */
/* eslint-disable no-useless-escape */
/* eslint-disable no-trailing-spaces */
/* eslint-disable @typescript-eslint/no-explicit-any */
/* eslint-disable spaced-comment */
/* eslint-disable eol-last */
/* eslint-disable linebreak-style */
/* eslint-disable require-jsdoc */
/* eslint-disable linebreak-style */

// import * as functions from "firebase-functions";
// import * as admin from "firebase-admin";
// import * as nodemailer from "nodemailer";
//cambiar las importaciones por require
const functions = require("firebase-functions");
const admin = require("firebase-admin");
const nodemailer = require("nodemailer");
const {google} = require("googleapis");
const {auth} = require("google-auth-library");
const {Worker} = require("worker_threads");

admin.initializeApp();

/* eslint-disable @typescript-eslint/no-unused-vars */
/* eslint-disable @typescript-eslint/no-var-requires */
// eslint-disable-next-line @typescript-eslint/no-unused-vars

// Configura la autenticación de correo electrónico

const mailTransport = nodemailer.createTransport({
  service: "gmail",
  auth: {
    user: "oficina@tecnoriasl.com",
    pass: "lvxupycgrvsmyxdb",
  },
});

// Función que se activa cada vez que se agrega un nuevo documento a la colección "contacto"

exports.sendEmailNotification = functions
  .region("europe-west1")
  .firestore.document("contacto/{contactId}")
  .onCreate(async (snapshot: any) => {
    // Recoge la información del nuevo documento
    const contact = snapshot.data();

    // Configura el contenido del correo electrónico

    const mailOptions = {
      from: contact.email,
      to: "oficina@tecnoriasl.com",
      subject: `${contact.empresa} - Solicita ${contact.service1}`,
      text: `
            Nombre: ${contact.name}\n
            Email: ${contact.email}\n
            Empresa: ${contact.empresa}\n
            Teléfono: ${contact.phone}\n
            Servicio Principal: ${contact.service1}\n
            Servicio detalle: ${contact.service2}\n
            Esto es del chat: ${contact?.service3}\n
            Sus comentarios: ${contact.message}`,
    };

    // Envía el correo electrónico
    try {
      await mailTransport.sendMail(mailOptions);
      console.log("Correo electrónico enviado a:", mailOptions.to);
    } catch (error) {
      console.error("No se pudo enviar el correo electrónico:", error);
    }
  });

// FUNCION PARA CREAR SITEMAP DE FORMA DINAMICA

export const updateSitemap = functions
  .region("europe-west1")
  .firestore.document("sitemap/{sitemapId}")
  .onCreate(async (_snapshot: any) => {
    // Recoge la información del nuevo documento
    const pagina = "https://tecnoriasl.com";
    const date = new Date().toISOString();
    const xml =
      "<urlset xmlns=\"http://www.sitemaps.org/schemas/sitemap/0.9\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:schemaLocation=\"http://www.sitemaps.org/schemas/sitemap/0.9 http://www.sitemaps.org/schemas/sitemap/0.9/sitemap.xsd\">";

    // OBTENER TODAS LAS RUTAS DESDE LA COLLECTION SITEMAP

    const routes = getRoutesFromSitemap();

    // GENERAR XML
    const xmlRoutes = routes.map((route: any) => {
      if (route === "/") {
        return `
            <url>
                <loc>${pagina}</loc>
                <lastmod>${date}</lastmod>
                <changefreq>monthly</changefreq>
                <priority>1.0</priority>
            </url>
        `;
      }
      if (route.includes("blog/")) {
        return `
            <url>
                <loc>${pagina}${route}</loc>
                <lastmod>${date}</lastmod>
                <changefreq>weekly</changefreq>
                <priority>0.64</priority>
            </url>
        `;
      }
      if (route.includes("faq/")) {
        return `
            <url>
                <loc>${pagina}${route}</loc>
                <lastmod>${date}</lastmod>
                <changefreq>weekly</changefreq>
                <priority>0.3</priority>
            </url>
        `;
      }

      return `
            <url>
                <loc>${pagina}${route}</loc>
                <lastmod>${date}</lastmod>
                <changefreq>daily</changefreq>
                <priority>0.8</priority>
            </url>
        `;
    });

    // GENERAR SITEMAP.XML
    const sitemapXml = xml + xmlRoutes.join("") + "</urlset>";
    // / almacenar sitemap.xml en el bucket de almacenamiento de Firebase
    uploadLocalFileToStorage(sitemapXml, "sitemap.xml");
  });

// FUNCION PARA OBTENER TODAS LAS RUTAS DESDE LA COLLECTION SITEMAP

function getRoutesFromSitemap() {
  const routes: any = [];
  const sitemap = admin.firestore().collection("sitemap");
  sitemap.get().then((querySnapshot: any) => {
    querySnapshot?.forEach((doc: any) => {
      routes.push(doc.data().url);
    });
  });
  return routes;
}

/**
 * Upload the file in firestore storage
 * @param {String} filePath
 * @param {String} fileName
 */

async function uploadLocalFileToStorage(filePath: string, fileName: string) {
  const imageBucket = "";

  const bucket = admin.storage().bucket();
  const destination = `${imageBucket}${fileName}`;
  try {
    // Uploads a local file to the bucket
    await bucket.upload(filePath, {
      destination: destination,
      gzip: true,
      metadata: {
        cacheControl: "public, max-age=31536000",
      },
    });

    console.log(`${fileName} uploaded to /${imageBucket}/${fileName}.`);
  } catch (e) {
    throw new Error("uploadLocalFileToStorage failed: " + e);
  }
}

const SCOPES = ["https://www.googleapis.com/auth/webmasters"];

async function requestIndexing(url) {
  try {
    const authClient = await auth.getClient({
      scopes: SCOPES,
    });

    const searchConsole = google.webmasters({
      version: "v3",
      auth: authClient,
    });

    const result = await searchConsole.urlTestingTools.mobileFriendlyTest({
      url: url,
      requestScreenshot: true,
    });

    return result.data;
  } catch (error) {
    console.error("Error requesting indexing:", error);
    throw new functions.https.HttpsError(
      "internal",
      "Error requesting indexing"
    );
  }
}

exports.indexBlogPost = functions.https.onCall(async (data, context) => {
  const url = data.url;
  const result = await requestIndexing(url);
  console.log("Indexing result:", result);
  return result;
});

////WORKER SCRAPER

export const companyScraper = functions
  .runWith({
    memory: "1GB",
    timeoutSeconds: 540,
  })
  .region("europe-west1")
  .https.onRequest(async (req, res) => {
    res.set("Access-Control-Allow-Origin", "*");
    res.set("Access-Control-Allow-Methods", "GET, PUT, POST, OPTIONS");
    res.set("Access-Control-Allow-Headers", "*");
    res.set("Access-Control-Max-Age", "86400");
    res.set("Access-Control-Allow-Credentials", "true");

    const query: any = req.query.url ? req.query.url : null;
    let objetoDatos: any = [];
    let nombreArchivo: any = "";

    nombreArchivo = query.split("/").pop().trim();
    nombreArchivo = nombreArchivo.replace(/\s/g, "");
    console.log(nombreArchivo);
    console.log(query);

    const worker = new Worker(__dirname + "worker_scraper.js", {
      workerData: query,
    });

    worker.on("message", (result) => {
      console.log(`Worker finished for ${query}: `, result);
      objetoDatos = objetoDatos.concat(result);
    });
    worker.on("error", (err) => {
      console.error(err);
    });
    worker.on("exit", async (code) => {
      if (code !== 0) {
        console.error(new Error(`Worker stopped with exit code ${code}`));
        res.status(500).send("Error writing file");
      } else {
        console.log(`All workers finished for ${query}`);
        try {
          await Promise.all([
            writeJsonFile(objetoDatos, nombreArchivo),
            // writeExcel(nombreArchivo), // Temporarily commented
          ]);
          console.log(
            `Files ${nombreArchivo}.json written successfully`
          );
          res.status(200).send("OK");
        } catch (err) {
          console.error(`Error writing files ${nombreArchivo}: `, err);
          res.status(500).send("Error writing file");
        }
      }
    });
  });

function writeJsonFile(objetoDatos: any, nombreArchivo: any) {
  //completar la funcion igual a la que ya habia en el index

  return new Promise<void>((resolve, reject) => {
    const json = JSON.stringify(objetoDatos);
    const bucket = admin.storage().bucket();
    const destination = __dirname + `/files/${nombreArchivo}.json`;
    const file = bucket.file(destination);
    const stream = file.createWriteStream({
      metadata: {
        contentType: "application/json",
      },
    });
    stream.on("error", (err) => {
      console.error(`Error writing file ${nombreArchivo}: `, err);
      reject(err);
    });
    stream.on("finish", () => {
      console.log(`File ${nombreArchivo} written successfully`);
      resolve();
    });
    stream.end(json);
  });
}
